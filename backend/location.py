import pandas as pd
from langchain_openai import ChatOpenAI
from langchain_experimental.agents import create_pandas_dataframe_agent

# from timezonefinder import TimezoneFinder
# ูุฏู ุณูุงุฑุด ุจุง API ุฎุงุฑุฌ
import openai

# ูพฺฉุฑุจูุฏ API ุณูุงุฑุด
openai.api_key = "aa-lx0ACUMXiI9u11BghecrW7SOLnag98S8OR3Vh59GuJMd6YQ3"
openai.api_base = "https://api.avalai.ir/v1"  # ุฌุงฺฏุฒู ฺฉู ุจุง ุขุฏุฑุณ ุฏุฑุณุช
# openai.api_base = "https://api.avalapis.ir/v1"  # ุฌุงฺฏุฒู ฺฉู ุจุง ุขุฏุฑุณ ุฏุฑุณุช

# ฺฏุงู ณ: ุณุงุฎุช ูุฏู
llm = ChatOpenAI(
    model="gpt-4o-mini",  # ุง ูุฑ ูุฏู ููุฑุฏ ูุธุฑ
    temperature=0,
    openai_api_base=openai.api_base,
    openai_api_key=openai.api_key
)




# ฺฏุงู ฑ: ุจุงุฑฺฏุฐุงุฑ ุงฺฉุณู
df = pd.read_excel("City.xlsx")

# ฺฏุงู ฒ: ุฌุฏุง ฺฉุฑุฏู ุงุณุชุงู ู ุดูุฑ + lat/lng
df[['Ostan', 'Shahr']] = df['City'].str.split(',', expand=True)
df['Ostan'] = df['Ostan'].str.strip()
df['Shahr'] = df['Shahr'].str.strip()
df[['lat', 'lng']] = df['Coordinates'].str.split(',', expand=True)
df['lat'] = df['lat'].astype(float)
df['lng'] = df['lng'].astype(float)

# print(df)

# ฺฏุงู ด: ุชุนุฑู ูพุฑุงููพุช
custom_prefix = """
ุจุง ุชูุฌู ุจู ุฏุงุฏูโูุง ูุฑูุฏ ฺฉุงุฑุจุฑุ ฺฉ ุดุก JSON ูุงููุฏ ููููู ุฒุฑ ุจุณุงุฒ. ููุท ุฏุฑ ุตูุฑุช ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุจุฏู ฺฉู ุชูุงู ุงุทูุงุนุงุช ุถุฑูุฑ (ูุงูุ ุชุงุฑุฎุ ุณุงุนุชุ ู ูุญู ุชููุฏ) ุจู ุทูุฑ ฺฉุงูู ู ูุงุจูโุงุณุชุฎุฑุงุฌ ุจุงุดูุฏ.

### โ ุงฺฏุฑ ุงุทูุงุนุงุช ฺฉุงูู ู ูุนุชุจุฑ ุจูุฏ:
- ููุท ูุชู JSON ุฑุง ุฎุฑูุฌ ุจุฏู.
- ูฺ ูุชู ุงุถุงู ูุจู ุง ุจุนุฏ ุงุฒ JSON ูููุณ.
- ุงฺฏุฑ ุชุงุฑุฎ ุชููุฏ ุจู ุดูุณ ุจูุฏุ ุจุง ุงุณุชูุงุฏู ุงุฒ ูุญุงุณุจู ุฏูู (ู ูู ุชุฎูู)ุ ุขู ุฑุง ุจู ููุงุฏ ุชุจุฏู ฺฉู.
- ุณุงุนุช ุชููุฏ ุฑุง ุงุฒ ุญุงูุช ฑฒ ุณุงุนุชู ูุซู "ุนุตุฑ" ุง "ุตุจุญ" ุจู ุญุงูุช ฒด ุณุงุนุชู ุชุจุฏู ฺฉู.
- lat ู lng ุฑุง ุจุง ุชุทุจู ุฏูู ุงุณุชุงู ู ุดูุฑ ุงุฒ ูุงู Excel ุงุณุชุฎุฑุงุฌ ฺฉู (ุชูุฌู: ููุท ฺฉ ุจุงุฑ ูุฌุงุฒ ุจู ุฎูุงูุฏู ูุงู ูุณุช).
- ูุงู ู ูุงู ุฎุงููุงุฏฺฏ ุฑุง ุฏูู ู ุจุฏูู ุฎุทุง ุจู ุงูฺฏูุณ ุชุฑุฌูู ฺฉู (ูุซูุงู ุงุฒ ุฑูุฏู ุฑุงุฏู ุจู "Roudin Radin").

### โ ุงฺฏุฑ ูุฑ ฺฉุฏุงู ุงุฒ ููุงุฑุฏ ุฒุฑ ูุงูุต ุง ูุจูู ุจูุฏ:
- ูุงู ุง ูุงู ุฎุงููุงุฏฺฏ ูุดุฎุต ูุจูุฏ
- ุชุงุฑุฎ ุชููุฏ ูุงูุต ุจูุฏ
- ุณุงุนุช ุชููุฏ ฺฏูฺฏ ุง ูุงูุดุฎุต ุจูุฏ
- ูุญู ุชููุฏ ุจุง ูุงู ูุทุงุจูุช ูุฏุงุดุช ุง ูุดุฎุต ูุจูุฏ

ุฏุฑ ุงู ุตูุฑุช ููุท ฺฉููู `False` ุฑุง ฺุงูพ ฺฉู. ูฺ ูุชู ุง ฺฉุงุฑุงฺฉุชุฑ ุงุถุงูู ุฏฺฏุฑ ูููุณ.

### ููููู JSON ุฎุฑูุฌ ูุนุชุจุฑ:
{
    "name": "Mohammad Safarzadeh",
    "year": "2025",
    "month": "03",
    "day": "29",
    "hour": "14",
    "minut": "30",
    "lat": "56.34532435",
    "lng": "32.34532435",
    "city": "Tabas",
    "tz_str": "Asia/Tehran"
}

### ุงุจุฒุงุฑูุง ุฏุฑ ุงุฎุชุงุฑ:
# Tools

## City (ููุท ฺฉ ุจุงุฑ ูุงุจู ุงุณุชูุงุฏู ุงุณุช)
- ุจุฑุง ุงุณุชุฎุฑุงุฌ lat ู lng ุดูุฑ ูุญู ุชููุฏ
- ุงู ุงุจุฒุงุฑ ููุท ฺฉ ุจุงุฑ ูุฌุงุฒ ุจู ุฎูุงูุฏู ูุงู ุงฺฉุณู ุงุณุชุ ุจูุงุจุฑุงู ุฏุฑ ุงุณุชูุงุฏู ุงุฒ ุขู ุฏูุช ฺฉู

---

ุงุทูุงุนุงุช ูุฑูุฏ ฺฉุงุฑุจุฑ ๐
""
ูุงู ู ูุงู ุฎุงููุงุฏฺฏ: ุฑูุฏู ุฑุงุฏู
ุชุงุฑุฎ ุชููุฏ: 01 ูุฑูุฑุฏู 1404
ุณุงุนุช ุชููุฏ: 22:22 ุนุตุฑ
ูุญู ุชููุฏ: ุงุณุชุงู - ุดูุฑ
""




"""

# ฺฏุงู ต: ุณุงุฎุช agent
agent = create_pandas_dataframe_agent(
    llm,
    df,
    prefix=custom_prefix,
    verbose=True,
    agent_type="openai-tools",  # ุง "zero-shot-react-description"
    handle_parsing_errors=True,
    allow_dangerous_code=True  # ๐ ุงูู ุงุถุงูู ฺฉู
)
# ฺฏุงู ถ: ฺฏุฑูุชู ููุทูู ุฒูุงู
# def add_timezone(json_result):
#     import json
#     tf = TimezoneFinder()
#     data = json.loads(json_result)
#     lat = float(data["lat"])
#     lng = float(data["lng"])
#     tz = tf.timezone_at(lat=lat, lng=lng)
#     data["tz_str"] = tz or "Asia/Tehran"
#     return data

# ฺฏุงู ท: ุงุฌุฑุง
query = """
ูุงู ู ูุงู ุฎุงููุงุฏฺฏ: ุฑูุฏู ุฑุงุฏู
ุชุงุฑุฎ ุชููุฏ: 01 ูุฑูุฑุฏู 1404
ุณุงุนุช ุชููุฏ: 22:22 ุนุตุฑ
ูุญู ุชููุฏ: ุฒุฏ - ุทุจุณ
"""

response = agent.run(query)
# result = add_timezone(response)

print(response)
